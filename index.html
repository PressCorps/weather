<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PressCorps Weather Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
      <!-- Leaflet CSS -->



    <style>
        body { margin: 0; padding: 0; background-color: #222; }
        #map { height: 100vh; width: 100vw; background: #1a1a1a; }
        
        /* Popup Styling */
        .leaflet-popup-content-wrapper { background: #2b2b2b; color: #eee; }
        .leaflet-popup-tip { background: #2b2b2b; }
        .popup-header { font-size: 1.1em; font-weight: bold; color: #ff9f43; margin-bottom: 5px; }
        .popup-data { margin: 5px 0; font-size: 0.9em; }
        .popup-link { display: block; margin-top: 8px; color: #54a0ff; text-decoration: none; }
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    
    <script>
// --- Custom Foxhole CRS ---
// Transformation(a, b, c, d) where:
// x_map = a*x_data + b
// y_map = c*y_data + d
// We set 'c' to 1 (instead of -1) to make Y increase downwards.
const MyCRS = L.extend({}, L.CRS.Simple, {
    transformation: new L.Transformation(1, 0, 1, 0) 
});

const map = L.map('map', {
    crs: MyCRS,
    center: [0.5, 0.5], // Center of the 0,0 to 1,1 square
    zoom: 9,
    minZoom: 8,
    maxZoom: 13
});

// Define the bounds where 0,0 is top-left and 1,1 is bottom-right
const bounds = [[0, 0], [1, 1]];

// --- MARKER GROUPS (Filter Toggles) ---
const layers = {
    "Rockets": L.layerGroup().addTo(map),
    "Weather": L.layerGroup().addTo(map),
    "Day Info": L.layerGroup().addTo(map),
    "Regions": L.layerGroup().addTo(map),
    "Other": L.layerGroup().addTo(map)
};

L.control.layers(null, layers, { collapsed: false }).addTo(map);

const dataUrl = 'https://opensheet.elk.sh/1nZR543Dekzy_7fpX6oUgXFnQD2WTOPCdngZ14i0GtFg/Points';

function loadMarkers() {
    fetch(dataUrl)
        .then(res => res.json())
        .then(data => {
            data.forEach(row => {
                // In Foxhole JSON: Latitude is usually Y, Longitude is usually X
                const lat = parseFloat(row.Latitude); 
                const lng = parseFloat(row.Longitude);

                // Validation
                if (isNaN(lat) || isNaN(lng)) return;

                // Handle Sizing
                let iconSize = [32, 32];
                if (row["Custom Size"] && row["Custom Size"].includes('x')) {
                    iconSize = row["Custom Size"].split('x').map(Number);
                }

                const customIcon = L.icon({
                    iconUrl: row["Marker Icon"] || "https://unpkg.com/leaflet/dist/images/marker-icon.png",
                    iconSize: iconSize,
                    iconAnchor: [iconSize[0] / 2, iconSize[1] / 2],
                    popupAnchor: [0, -iconSize[1] / 2]
                });

                const popupContent = `
                    <div class="popup-header">${row.Name || "Unnamed"}</div>
                    <div class="popup-data">${row.Description || "No description."}</div>
                    <div style="font-size: 0.7em; color: #888; margin-top: 5px;">${row.UPDATE || ""}</div>
                `;

                // Add marker: [Y, X] in Leaflet matches [Latitude, Longitude]
                const m = L.marker([lat, lng], { icon: customIcon }).bindPopup(popupContent);

                // Group Logic
                const group = row.Group ? row.Group.toUpperCase() : "";
                if (group === "ROCKET") layers["Rockets"].addLayer(m);
                else if (group === "WEATHER") layers["Weather"].addLayer(m);
                else if (group === "DAY") layers["Day Info"].addLayer(m);
                else if (group === "REGION NAME") layers["Regions"].addLayer(m);
                else layers["Other"].addLayer(m);
            });
        });
}

// Load Overlays (Ensure images also use the 0,0 to 1,1 bounds)
fetch("https://opensheet.elk.sh/1nZR543Dekzy_7fpX6oUgXFnQD2WTOPCdngZ14i0GtFg/Map_Overlays")
    .then(res => res.json())
    .then(data => {
        data.forEach(row => {
            if (row.image_url) {
                L.imageOverlay(row.image_url, bounds).addTo(map);
            }
        });
        map.fitBounds(bounds);
        loadMarkers(); // Load markers after map bounds are set
    });

            
        
    </script>
</body>
</html>
