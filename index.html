<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PressCorps Weather Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; background-color: #222; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #1a1a1a; }
        
        /* Coordinate Helper HUD */
        #coord-hud {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 2000;
            background: rgba(30, 30, 30, 0.9);
            color: #ff9f43;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* Leaflet Overrides */
        .leaflet-popup-content-wrapper { background: #2b2b2b; color: #eee; border-radius: 4px; border: 1px solid #444; }
        .leaflet-popup-tip { background: #2b2b2b; }
        .popup-header { font-size: 1.1em; font-weight: bold; color: #ff9f43; border-bottom: 1px solid #444; margin-bottom: 5px; padding-bottom: 3px; }
        .popup-data { margin: 8px 0; font-size: 0.9em; color: #ccc; }
        .popup-footer { font-size: 0.75em; color: #777; font-style: italic; }
        .leaflet-control-layers { background: #2b2b2b !important; color: #eee !important; border: none !important; }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="coord-hud">Initialize Map...</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- 1. CONFIGURATION & CONSTANTS ---
        const mapWidth = 1024;
        const mapHeight = 888;
        const pixelWorldWidth = 10320; 
        const pixelWorldHeight = 6213;
        const gridIntervalWidth = 768;
        const gridIntervalHeight = 444;

        // Scaling logic for CRS.Simple
        const scale = 256 / Math.max(pixelWorldWidth, pixelWorldHeight);
        const offsetX = (pixelWorldWidth < pixelWorldHeight) ? (pixelWorldHeight - pixelWorldWidth) / 2 : 0;
        const offsetY = (pixelWorldHeight < pixelWorldWidth) ? (pixelWorldWidth - pixelWorldHeight) / 2 : 0;

        const southWest = L.latLng((pixelWorldHeight + offsetY) * scale * -1, offsetX * scale);
        const northEast = L.latLng(offsetY * scale * -1, (pixelWorldWidth + offsetX) * scale);
        const worldBounds = L.latLngBounds(southWest, northEast);

        // --- 2. INITIALIZE MAP ---
        const map = L.map('map', {
            crs: L.CRS.Simple,
            maxBounds: worldBounds,
            maxBoundsViscosity: 1.0,
            center: worldBounds.getCenter(), 
            zoom: 3,
            minZoom: 2,
            maxZoom: 8,
            attributionControl: false
        });

        // --- 3. REGION INDEX ---
        const localIndex = {
            "Allods Bight": { x: 8, y: 8 }, "Callahans Passage": { x: 6, y: 4 }, "Deadlands": { x: 6, y: 6 },
            "The Drowned Vale": { x: 7, y: 7 }, "Endless Shore": { x: 9, y: 7 }, "Farranac Coast": { x: 3, y: 5 },
            "Fishermans Row": { x: 2, y: 6 }, "Godcrofts": { x: 10, y: 4 }, "Great March": { x: 6, y: 10 },
            "The Heartlands": { x: 5, y: 9 }, "The Linn of Mercy": { x: 5, y: 5 }, "Loch MÃ³r": { x: 5, y: 7 },
            "Marban Hollow": { x: 7, y: 5 }, "The Moors": { x: 5, y: 3 }, "Oarbreaker Isles": { x: 1, y: 7 },
            "Reaching Trail": { x: 6, y: 2 }, "Shackled Chasm": { x: 7, y: 9 }, "Stonecradle": { x: 4, y: 4 },
            "Tempest Island": { x: 10, y: 6 }, "Umbral Wildwood": { x: 6, y: 8 }, "Viper Pit": { x: 7, y: 3 },
            "Weathered Expanse": { x: 8, y: 4 }, "Westgate": { x: 3, y: 7 }, "Acrithia": { x: 7, y: 11 },
            "Ash Fields": { x: 4, y: 10 }, "Basin Sionnach": { x: 6, y: 0 }, "Callums Cape": { x: 4, y: 2 },
            "Clanshead Valley": { x: 8, y: 2 }, "Howl County": { x: 7, y: 1 }, "Kalokai": { x: 6, y: 12 },
            "Morgens Crossing": { x: 9, y: 3 }, "Nevish Line": { x: 3, y: 3 }, "Origin": { x: 3, y: 9 },
            "Red River": { x: 5, y: 11 }, "Speaking Woods": { x: 5, y: 1 }, "Terminus": { x: 8, y: 10 },
            "The Fingers": { x: 11, y: 7 }, "Sableport": { x: 4, y: 8 }, "Kings Cage": { x: 4, y: 6 },
            "Reavers Pass": { x: 9, y: 9 }, "Stema Landing": { x: 2, y: 8 }, "Stlican Shelf": { x: 9, y: 5 },
            "The Clahstra": { x: 8, y: 6 }, "Olavis Wake": { x: 0, y: 4 }, "Pari Peak": { x: 1, y: 3 },
            "Palantine Berm": { x: 1, y: 5 }, "Kuura Strand": { x: 2, y: 2 }, "The Gutter": { x: 2, y: 4 },
            "Wresta": { x: 10, y: 8 }, "Onyx": { x: 10, y: 10 }, "Lykos Isle": { x: 11, y: 5 },
            "Tyrant Foothills": { x: 11, y: 9 }, "Pipers Enclave": { x: 12, y: 8 }
        };

        // --- 4. PROJECTION ENGINE ---
        function projectToLeaflet(regionName, localX, localY) {
            const cleanName = regionName ? regionName.trim() : null;
            const region = localIndex[cleanName];
            if (!region) return null;

            // Calculate world pixel position
            const worldX = (gridIntervalWidth * region.x) + (mapWidth * localX) + offsetX;
            const worldY = (gridIntervalHeight * region.y) + (mapHeight * localY) + offsetY;

            // Return inverted Y for Leaflet
            return L.latLng(worldY * scale * -1, worldX * scale);
        }

        // --- 5. LAYERS ---
        const layers = {
            "Rockets": L.layerGroup().addTo(map),
            "Weather": L.layerGroup().addTo(map),
            "Day Info": L.layerGroup().addTo(map),
            "Regions": L.layerGroup().addTo(map),
            "Other": L.layerGroup().addTo(map)
        };
        L.control.layers(null, layers, { collapsed: false }).addTo(map);

        // --- 6. DATA LOADING ---
        // Markers
        fetch('https://opensheet.elk.sh/1nZR543Dekzy_7fpX6oUgXFnQD2WTOPCdngZ14i0GtFg/Points')
            .then(res => res.json())
            .then(data => {
                data.forEach(row => {
                    const region = row.HEX || row.OTHER;
                    const lX = parseFloat(row.Longitude);
                    const lY = parseFloat(row.Latitude);

                    if (!region || isNaN(lX) || isNaN(lY)) return;

                    const coords = projectToLeaflet(region, lX, lY);
                    if (!coords) return;

                    let size = [32, 32];
                    if (row["Custom Size"] && row["Custom Size"].includes('x')) {
                        size = row["Custom Size"].split('x').map(Number);
                    }

                    const icon = L.icon({
                        iconUrl: row["Marker Icon"] || "https://unpkg.com/leaflet/dist/images/marker-icon.png",
                        iconSize: size,
                        iconAnchor: [size[0]/2, size[1]/2],
                        popupAnchor: [0, -size[1]/2]
                    });

                    const m = L.marker(coords, { icon: icon }).bindPopup(`
                        <div class="popup-header">${row.Name || "Point of Interest"}</div>
                        <div class="popup-data">${row.Description || ""}</div>
                        <div class="popup-footer">Last Updated: ${row.UPDATE || "Unknown"}</div>
                    `);

                    const g = (row.Group || "").toUpperCase();
                    if (g.includes("ROCKET")) layers["Rockets"].addLayer(m);
                    else if (g.includes("WEATHER")) layers["Weather"].addLayer(m);
                    else if (g.includes("DAY")) layers["Day Info"].addLayer(m);
                    else if (g.includes("REGION")) layers["Regions"].addLayer(m);
                    else layers["Other"].addLayer(m);
                });
            });

        // Background Images
        fetch("https://opensheet.elk.sh/1nZR543Dekzy_7fpX6oUgXFnQD2WTOPCdngZ14i0GtFg/Map_Overlays")
            .then(res => res.json())
            .then(data => {
                data.forEach(row => {
                    if (row.image_url) {
                        // pane: 'tilePane' ensures it stays UNDER the markers
                        L.imageOverlay(row.image_url, worldBounds, { pane: 'tilePane', zIndex: 1 }).addTo(map);
                    }
                });
            });

        // --- 7. COORDINATE HUD LOGIC ---
        const hud = document.getElementById('coord-hud');
        map.on('mousemove', function(e) {
            const worldX = e.latlng.lng / scale - offsetX;
            const worldY = (e.latlng.lat / (scale * -1)) - offsetY;

            const gridX = Math.floor(worldX / gridIntervalWidth);
            const gridY = Math.floor(worldY / gridIntervalHeight);

            let regionName = "Ocean";
            for (const [name, coords] of Object.entries(localIndex)) {
                if (coords.x === gridX && coords.y === gridY) {
                    regionName = name;
                    break;
                }
            }

            const localX = ((worldX - (gridX * gridIntervalWidth)) / mapWidth).toFixed(4);
            const localY = ((worldY - (gridY * gridIntervalHeight)) / mapHeight).toFixed(4);

            if (worldX < 0 || worldY < 0 || worldX > pixelWorldWidth || worldY > pixelWorldHeight) {
                hud.innerHTML = "OUT OF BOUNDS";
            } else {
                hud.innerHTML = `<strong>REGION:</strong> ${regionName}<br><strong>LAT (Y):</strong> ${localY}<br><strong>LONG (X):</strong> ${localX}`;
            }
        });
    </script>
</body>
</html>
