<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foxhole Data Map</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
     crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; background: #242424; }
        
        /* Optional: Style for the popup text */
        .popup-content b { color: #d35400; }
        .popup-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 5px 10px;
            background: #333;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
     crossorigin=""></script>

    <script>
        // 1. Initialize Map with Custom Coordinate Reference System (Simple)
        // This is standard for game maps/flat images.
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            zoomSnap: 0.5,
            zoomDelta: 0.5
        });

        // 2. Define Bounds as requested
        const bounds = [[-1, -1], [1, 1]];

        // 3. Define Image Layers
        // Background Map
        const backgroundLayer = L.imageOverlay('https://foxholestats.com/images/WorldMapControl.webp', bounds).addTo(map);
        
        // Subregions Overlay (Assuming local file 'media/SUBREGIONS.png')
        const subregionsLayer = L.imageOverlay('media/SUBREGIONS.png', bounds);

        // Weather Alerts Overlay
        const wxAlertsLayer = L.imageOverlay('https://raw.githubusercontent.com/PressCorps/API/refs/heads/main/wx%20alerts/wx%20alert.png', bounds);

        // 4. Initialize Marker Layer Groups
        const rocketLayer = L.layerGroup();
        const weatherLayer = L.layerGroup();
        const dayLayer = L.layerGroup();
        const regionNameLayer = L.layerGroup();

        // 5. Setup Layer Control
        const baseMaps = {
            "Base Map": backgroundLayer
        };

        const overlayMaps = {
            "Subregions": subregionsLayer,
            "Wx Alerts": wxAlertsLayer,
            "Rockets": rocketLayer,
            "Weather Stations": weatherLayer,
            "Day Info": dayLayer,
            "Region Names": regionNameLayer
        };

        L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

        // Fit map to bounds initially
        map.fitBounds(bounds);

        // 6. Fetch and Process Data
        const dataUrl = 'https://opensheet.elk.sh/1nZR543Dekzy_7fpX6oUgXFnQD2WTOPCdngZ14i0GtFg/Points';

        fetch(dataUrl)
            .then(response => response.json())
            .then(data => {
                data.forEach(point => {
                    processPoint(point);
                });
            })
            .catch(error => console.error('Error fetching data:', error));

        function processPoint(point) {
            // Ensure we have coordinates
            if (!point.Latitude || !point.Longitude) return;

            const lat = parseFloat(point.Latitude);
            const lng = parseFloat(point.Longitude);

            // Create Icon (Logic to handle custom icons or fallbacks)
            let iconUrl = point["Marker Icon"];
            
            // Fix for 'media/' paths if not running locally, or handle 'blank.png'
            if (iconUrl === 'media/blank.png') {
                // If it's blank, we might want a default circle marker instead, 
                // or a transparent icon. For visibility, I'll use a default leaflet icon
                // unless specified otherwise.
                // Uncomment the line below to use actual blank png if you have it
                // iconUrl = 'path/to/transparent.png'; 
            }

            const customIcon = L.icon({
                iconUrl: iconUrl && iconUrl !== "" ? iconUrl : 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                iconSize: point["Custom Size"] ? point["Custom Size"].split('x').map(Number) : [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34]
            });

            // Build Popup Content
            let popupContent = `<div class="popup-content">
                <h3>${point.Name || 'Unknown'}</h3>
                <p>${point.UPDATE || ''}</p>
                ${point.Description ? `<p>${point.Description}</p>` : ''}
            `;

            if (point["Wx Submit Link"]) {
                popupContent += `<a href="${point["Wx Submit Link"]}" target="_blank" class="popup-btn">Submit Report</a>`;
            }
            popupContent += `</div>`;

            // Create Marker
            const marker = L.marker([lat, lng], { icon: customIcon });
            marker.bindPopup(popupContent);

            // Assign to Layer Group based on "Group" property
            const groupName = point.Group ? point.Group.toUpperCase().trim() : "OTHER";

            switch (groupName) {
                case 'ROCKET':
                    rocketLayer.addLayer(marker);
                    // Optionally add to map by default:
                    rocketLayer.addTo(map); 
                    break;
                case 'WEATHER':
                    weatherLayer.addLayer(marker);
                    weatherLayer.addTo(map);
                    break;
                case 'DAY':
                    dayLayer.addLayer(marker);
                    dayLayer.addTo(map);
                    break;
                case 'REGION NAME':
                    regionNameLayer.addLayer(marker);
                    regionNameLayer.addTo(map);
                    break;
                default:
                    // Add miscellaneous items to a generic layer or ignore
                    console.log("Uncategorized Group:", groupName);
            }
        }
    </script>
</body>
</html>
